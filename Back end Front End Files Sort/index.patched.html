<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåç Biblical Prophecy Intelligence Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #000000 0%, #1a0000 25%, #001a1a 50%, #1a001a 75%, #000000 100%);
      color: #00ff88;
      min-height: 100vh;
      overflow-y: auto;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .header {
      text-align: center; margin-bottom: 20px; background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px); border-radius: 20px; padding: 24px; border: 2px solid #00ff88;
      box-shadow: 0 0 20px rgba(0,255,136,0.3);
    }
    h1 { font-size: 3em; color: #00ff88; text-shadow: 0 0 15px #00ff88; margin-bottom: 8px; }
    .subtitle { opacity: .9; font-size: 1.2em; color: #00ff88; }

    /* Toolbar */
    .toolbar {
      display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin: 10px 0 20px;
    }
    .btn-primary, .btn-secondary {
      padding: 8px 14px; border-radius: 8px; border: 1px solid #00ff88;
      background: rgba(0,0,0,0.7); color: #00ff88; cursor: pointer; font-family: inherit;
    }
    .btn-secondary { border-color: #888; color: #ccc; }
    .btn-primary:hover { box-shadow: 0 0 12px rgba(0,255,136,.35); }

    .global-status {
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .global-meter { display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .prophecy-level { font-size: 1.2em; font-weight: bold; color: #ff4444; text-shadow: 0 0 10px #ff4444; }
    .progress-bar {
      width: 300px; height: 25px; background: rgba(0,0,0,0.8); border: 2px solid #ff4444;
      border-radius: 15px; overflow: hidden; position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88 0%, #ffff00 50%, #ff4444 100%);
      transition: width 0.8s ease; width: 87%; box-shadow: 0 0 15px rgba(255,68,68,0.8);
    }
    .progress-text {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #000; font-weight: bold; font-size: 1em;
    }

    .topic-categories {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px; margin-bottom: 28px;
    }
    .topic-card {
      background: rgba(0,0,0,0.8); border: 1px solid #00ff88; border-radius: 15px; padding: 25px;
      box-shadow: 0 0 15px rgba(0,255,136,0.2); transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .topic-card:hover { transform: translateY(-4px); border-color: #00ff88; box-shadow: 0 0 25px rgba(0,255,136,0.4); }
    .topic-card::before { content: ''; position: absolute; top:0; left:0; right:0; height:3px;
      background: linear-gradient(90deg, #ff4444, #ffff00, #00ff88);
    }
    .topic-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .topic-title { color: #00ff88; font-size: 1.5em; font-weight: bold; text-shadow: 0 0 8px #00ff88, 0 0 12px rgba(0,255,136,0.5); cursor: pointer; }
    .topic-score { background:#ff4444; color:#fff; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 1.1em; min-width: 60px; text-align: center;}
    .score-high { background: #ff4444; } .score-medium { background: #ffaa00; } .score-low { background: #00aa00; }

    .topic-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 14px; }
    .mini-stat { text-align: center; background: rgba(20, 20, 20, 0.8); padding: 10px; border-radius: 8px; border: 1px solid #333; }
    .mini-stat-number { font-size: 1.3em; font-weight: bold; color: #00ff88; }
    .mini-stat-label { font-size: .8em; color: #888; margin-top: 4px; }

    .domain-header {
      font-size: 2em;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
      margin: 40px 0 20px 0;
      border-bottom: 2px solid rgba(255,215,0,0.3);
      padding-bottom: 10px;
    }
    .topic-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
    }

    .topic-keywords { margin-top: 15px; }
    .keyword { display: inline-block; background: rgba(0, 255, 136, 0.1); color: #00ff88; padding: 4px 8px; border-radius: 5px; margin: 2px; font-size: 0.85em; text-decoration: none; border: 1px solid rgba(0, 255, 136, 0.2); }
    .keyword:hover { background: rgba(0, 255, 136, 0.2); border-color: #00ff88; }

    .topic-subcategories { margin-top: 10px; }
    .subcategory { display: inline-block; background: rgba(0, 136, 255, 0.1); color: #0088ff; padding: 4px 8px; border-radius: 5px; margin: 2px; font-size: 0.85em; text-decoration: none; border: 1px solid rgba(0, 136, 255, 0.2); }
    .subcategory:hover { background: rgba(0, 136, 255, 0.2); border-color: #0088ff; }

    .recent-articles {
      max-height: 220px; /* Adjust as needed for 5-7 articles */
      overflow-y: auto;
      margin-top: 15px;
      padding-right: 10px; /* For scrollbar */
    }
    .article-item { background: rgba(20,20,20,0.8); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #00ff88; cursor: pointer; transition: all .2s ease; }
    .article-item:hover { background: rgba(20,20,20,0.9); transform: translateX(3px); }
    .article-title { font-weight: bold; color: #00ff88; margin-bottom: 5px; font-size: 0.95em; line-height: 1.3; }
    .article-meta { display:flex; justify-content: space-between; align-items: center; font-size: .8em; opacity: .8; }
    .article-score { background: rgba(255,68,68,0.8); color:#fff; padding: 2px 8px; border-radius: 10px; font-weight: bold; }

    .card-delete {
      position: absolute; top: 8px; right: 10px; color: #888; font-weight: bold; cursor: pointer;
      background: transparent; border: none; font-size: 18px; line-height: 1;
    }
    .card-delete:hover { color: #ff4444; }

    .global-stats { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 24px; border: 1px solid rgba(255,215,0,0.3); }
    .stats-title { text-align: center; color: #ffd700; font-size: 1.6em; font-weight: bold; margin-bottom: 18px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; }
    .stat-card { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .stat-number { font-size: 2.2em; font-weight: bold; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .stat-label { opacity: .85; margin-top: 6px; font-size: 1.05em; }

    
    /* Fullscreen topic detail overlay */
    .topic-detail-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.75); display:none; z-index:2000; }
    .topic-detail { position: fixed; inset:40px; background: rgba(0,0,0,0.95); border:2px solid #00ff88; border-radius:16px; padding:20px; overflow:auto; z-index:2001; display:none; }
    .topic-detail header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .topic-detail .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topic-detail .controls select, .topic-detail .controls input { background:#000; color:#00ff88; border:1px solid #00ff88; border-radius:8px; padding:6px 8px; }
    .topic-detail .metrics { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:12px; margin:12px 0; }
    .topic-detail .metric { background: rgba(255,255,255,0.06); border:1px solid rgba(0,255,136,0.35); border-radius:12px; padding:10px; text-align:center; }
    .topic-detail .big { font-size:1.5rem; font-weight:700; }
    .topic-detail .article-list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .topic-detail .article-item { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:10px; }
    .topic-detail .article-title { font-weight:700; }
    .topic-detail .close-btn { border:1px solid #ff4444; color:#ff8888; background:transparent; padding:6px 10px; border-radius:8px; cursor:pointer; }
.live-ticker {
      position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95);
      border-top: 2px solid #00ff88; height: 50px; overflow: hidden; z-index: 1000;
    }
    .ticker-content { display:flex; animation: scroll-left 45s linear infinite; align-items: center; height: 100%; white-space: nowrap; }
    @keyframes scroll-left { 0% { transform: translateX(100%);} 100% { transform: translateX(-100%);} }
    .ticker-item { margin: 0 40px; padding: 8px 16px; border-radius: 15px; display: inline-block; font-weight: bold; }
    .ticker-critical { background: rgba(255,68,68,0.3); color:#ff4444; }
    .ticker-high { background: rgba(255,170,0,0.3); color:#ffaa00; }
    .ticker-medium { background: rgba(0,255,136,0.3); color:#00ff88; }

    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.6;} }

    /* Modal */
    .modal.hidden { display: none; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.65); display: grid; place-items: center; z-index: 2000; }
    .modal-content {
      width: min(520px, 96vw); background: rgba(0,0,0,0.9); border: 1px solid #00ff88;
      border-radius: 14px; padding: 18px 20px; box-shadow: 0 0 25px rgba(0,255,136,0.25);
    }
    .modal-content h2 { margin-bottom: 12px; color: #00ff88; }
    .modal-content label { display: block; margin: 10px 0; font-size: 0.95em; }
    .modal-content input, .modal-content textarea, .modal-content select {
      width: 100%; margin-top: 6px; padding: 8px 10px; border-radius: 8px; border: 1px solid #333;
      background: rgba(20,20,20,0.9); color: #00ff88; font-family: inherit;
    }
    .modal-content textarea { resize: vertical; min-height: 60px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; }

    /* Feed Test Section */
    .feed-test-section {
      background: rgba(0,50,100,0.2); border: 1px solid #0088ff; border-radius: 15px;
      padding: 20px; margin: 20px 0;
    }
    .feed-test-title { color: #0088ff; font-size: 1.3em; font-weight: bold; margin-bottom: 15px; }
    .test-feed-input { display: flex; gap: 10px; margin-bottom: 15px; }
    .test-url { flex: 1; }
    .test-results { background: rgba(0,0,0,0.5); border-radius: 10px; padding: 15px; margin-top: 10px; max-height: 200px; overflow-y: auto; }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 2.2em; }
      .topic-categories { grid-template-columns: 1fr; gap: 20px; }
      .global-meter { flex-direction: column; gap: 15px; }
      .progress-bar { width: 280px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üåç Biblical Prophecy Intelligence</h1>
      <p class="subtitle">Real-Time Monitoring & Analysis Dashboard</p>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button id="btnTestFeed" class="btn-secondary">Test Feed</button>
      <button id="btnExport" class="btn-secondary">Export Data</button>
      <button id="btnImport" class="btn-secondary">Import Data</button>
      <button id="btnNewCard" class="btn-primary">+ New Card</button>
    </div>

    <!-- Feed Testing Section (collapsible) -->
    <div class="feed-test-section" id="feedTestSection" style="display: none;">
      <div class="feed-test-title">üîó Feed Testing & Smart Categorization</div>
      <div class="test-feed-input">
        <input type="url" id="testFeedUrl" placeholder="https://example.com/rss or https://api.example.com/articles" class="test-url">
        <button id="testFeedBtn" class="btn-primary">Test Feed</button>
      </div>
      <div class="test-results" id="testResults" style="display: none;"></div>
    </div>

    <!-- Global Status Meter -->
    <div class="global-status">
      <div class="global-meter">
        <div class="prophecy-level">GLOBAL PROPHECY STATUS</div>
        <div class="progress-bar">
          <div class="progress-fill" id="globalProgress"></div>
          <div class="progress-text" id="globalPercentage">87%</div>
        </div>
        <div id="globalStatus" style="color:#ff4444; font-weight: bold;">CRITICAL CONVERGENCE</div>
      </div>
    </div>

    <!-- Topic Categories -->
    <div id="topicContainer"></div>

    <!-- Global Statistics -->
    <div class="global-stats">
      <div class="stats-title">üìä System Intelligence Overview</div>
      <div class="stats-grid" id="globalStatsGrid"></div>
    </div>
  </div>

  <!-- Live News Ticker -->
  <div class="live-ticker">
    <div class="ticker-content" id="liveTicker"></div>
  </div>

  <!-- New Card Modal -->
  <div id="newCardModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Create Topic Card</h2>
      <form id="newCardForm">
        <label>Title
          <input type="text" id="nc_title" placeholder="e.g., üõ∞Ô∏è Space Treaties" required>
        </label>

        <label>Slug/ID (auto from title; you can edit)
          <input type="text" id="nc_id" placeholder="space_treaties" required>
        </label>

        <label>Keywords for Smart Sorting (comma-separated)
          <textarea id="nc_keywords" placeholder="space, treaty, satellite, international law, UN" rows="2"></textarea>
        </label>

        <label>Current Score (0‚Äì10)
          <input type="number" id="nc_currentScore" min="0" max="10" step="0.1" value="7.0" required>
        </label>

        <label>Yesterday Score (0‚Äì10)
          <input type="number" id="nc_yesterdayScore" min="0" max="10" step="0.1" value="6.8" required>
        </label>

        <label>Monthly Avg (0‚Äì10)
          <input type="number" id="nc_monthlyAvg" min="0" max="10" step="0.1" value="6.5" required>
        </label>

        <label>Today's Articles (integer)
          <input type="number" id="nc_todayArticles" min="0" step="1" value="5" required>
        </label>

        <label>Card URL (where click opens)
          <input type="url" id="nc_url" placeholder="/space-treaties" required>
        </label>

        <label>Feed URL (optional, RSS/JSON feed)
          <input type="url" id="nc_feedUrl" placeholder="https://example.com/rss or API endpoint">
        </label>

        <div class="modal-actions">
          <button type="button" id="nc_cancel" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2>Import Data</h2>
      <label>Paste JSON data:
        <textarea id="importData" rows="10" placeholder='[{"id":"example","title":"Example","currentScore":7.0,...}]'></textarea>
      </label>
      <div class="modal-actions">
        <button type="button" id="import_cancel" class="btn-secondary">Cancel</button>
        <button type="button" id="import_confirm" class="btn-primary">Import</button>
      </div>
    </div>
  </div>

  <script>
    // Smart Feed Categorization Engine
    class SmartFeedCategorizer {
      constructor() {
        this.categories = new Map();
      }

      addCategory(id, keywords) {
        this.categories.set(id, keywords.map(k => k.toLowerCase()));
      }

      categorizeArticle(article) {
        const text = `${article.title} ${article.description || ''}`.toLowerCase();
        const scores = new Map();

        for (const [categoryId, keywords] of this.categories) {
          let score = 0;
          for (const keyword of keywords) {
            if (text.includes(keyword)) {
              score += 1;
            }
          }
          if (score > 0) {
            scores.set(categoryId, score);
          }
        }

        if (scores.size === 0) return null;
        
        // Return highest scoring category
        return Array.from(scores.entries()).sort((a, b) => b[1] - a[1])[0][0];
      }
    }

    // Feed Parser
    class FeedParser {
      static async parse(url) {
        try {
          // For RSS feeds, we'd need a CORS proxy or server-side processing
          // For now, simulate the feed parsing
          console.log(`Would parse feed: ${url}`);
          
          // Return mock data for demonstration
          return [
            {
              title: "Sample Article from Feed",
              description: "This is a sample article that would come from the RSS feed",
              url: url,
              pubDate: new Date(),
              score: Math.floor(Math.random() * 10) + 1
            }
          ];
        } catch (error) {
          console.error('Feed parsing error:', error);
          return [];
        }
      }
    }

    // Main Dashboard Class
    class ProphecyIntelligenceDashboard {
      constructor() {
        this.storageKey = 'bpi_topics_v2';
        this.categorizer = new SmartFeedCategorizer();
        this.topics = this.loadTopics();
        this.updateInterval = 30000;
        this.setupCategorizer();
        this.init();
      }

      setupCategorizer() {
        // Setup keyword categories based on existing topics
        this.topics.forEach(topic => {
          if (topic.keywords) {
            this.categorizer.addCategory(topic.id, topic.keywords);
          }
        });
      }

      loadTopics() {
        try {
          const raw = localStorage.getItem(this.storageKey);
          if (raw) {
            const arr = JSON.parse(raw);
            if (Array.isArray(arr) && arr.length) return arr;
          }
        } catch (e) {
          console.warn('Failed to load topics from localStorage:', e);
        }
        
        return [
          { 
            id:'antichrist', 
            title:'üë§ Antichrist Candidates', 
            domain: 'prophetic_end_times',
            keywords: ['antichrist', 'world leader', 'global government', 'one world', 'dictator', 'emperor'],
            subCategories: ['UN', 'WEF', 'Globalism'],
            currentScore:8.7, 
            yesterdayScore:8.2, 
            monthlyAvg:7.9, 
            weeklyTrend: 1.1,
            todayArticles:23, 
            url:'/antichrist',
            feedUrl: null
          },
          { 
            id:'temple_mount', 
            title:'üïå Temple Mount Events', 
            domain: 'prophetic_end_times',
            keywords: ['temple mount', 'third temple', 'jerusalem', 'al-aqsa', 'red heifer', 'temple institute'],
            subCategories: ['Red Heifer', 'Sacrifice', 'Third Temple'],
            currentScore:9.1, 
            yesterdayScore:8.8, 
            monthlyAvg:8.5, 
            weeklyTrend: 0.5,
            todayArticles:15, 
            url:'/temple-mount',
            feedUrl: null
          },
          { 
            id:'israel_security', 
            title:'üáÆüá± Israel Security', 
            domain: 'geopolitical_societal_shifts',
            keywords: ['israel', 'idf', 'gaza', 'hamas', 'hezbollah', 'iran', 'israeli'],
            subCategories: ['Gaza', 'West Bank', 'Iran Proxy'],
            currentScore:8.9, 
            yesterdayScore:9.2, 
            monthlyAvg:8.6, 
            weeklyTrend: -0.2,
            todayArticles:31, 
            url:'/israel-security',
            feedUrl: null
          },
          { 
            id:'digital_currency', 
            title:'üí≥ Digital Currency/Mark', 
            domain: 'prophetic_end_times',
            keywords: ['digital currency', 'cbdc', 'mark of the beast', 'biometric', 'digital id', 'cashless'],
            subCategories: ['CBDC', 'Digital ID', 'Biometrics'],
            currentScore:8.3, 
            yesterdayScore:8.0, 
            monthlyAvg:7.7, 
            weeklyTrend: 0.8,
            todayArticles:20, 
            url:'/digital-currency',
            feedUrl: null
          },
          { 
            id:'church_decline', 
            title:'‚õ™ Church Apostasy', 
            domain: 'god_theology_centered',
            keywords: ['church', 'apostasy', 'heresy', 'false doctrine', 'prosperity gospel', 'compromised'],
            subCategories: ['Mainline', 'Emergent', 'Woke'],
            currentScore:7.4, 
            yesterdayScore:7.1, 
            monthlyAvg:7.0, 
            weeklyTrend: 0.4,
            todayArticles:18, 
            url:'/church-decline',
            feedUrl: null
          },
          { 
            id:'middle_east_war', 
            title:'‚öîÔ∏è Middle East Conflict', 
            domain: 'prophetic_end_times',
            keywords: ['middle east', 'syria', 'turkey', 'russia', 'gog magog', 'war', 'conflict'],
            subCategories: ['Gog/Magog', 'Ezekiel 38', 'Psalm 83'],
            currentScore:7.8, 
            yesterdayScore:7.5, 
            monthlyAvg:7.3, 
            weeklyTrend: 0.6,
            todayArticles:28, 
            url:'/middle-east-war',
            feedUrl: null
          }
        ];
      }

      saveTopics() {
        try { 
          localStorage.setItem(this.storageKey, JSON.stringify(this.topics)); 
        }
        catch (e) { 
          console.warn('‚ùå Unable to persist topics:', e); 
        }
      }

      slugify(s) {
        return String(s || '').toLowerCase()
          .replace(/[^\w\s-]/g,'')
          .trim()
          .replace(/\s+/g,'_')
          .replace(/_+/g,'_');
      }

      topicExists(id) { 
        return this.topics.some(t => t.id === id); 
      }

      escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      init() {
        console.log('üìä Setting up dashboard components...');
        this.setupModals();
        this.setupFeedTesting();
        this.renderTopicCards();
        this.renderGlobalStats();
        this.updateGlobalMeter();
        this.updateTicker();
        this.startRealTimeUpdates();
        this.setupEventListeners();
        console.log('‚úÖ Dashboard initialized successfully');
        if (location.hash.startsWith('#topic/')) { const id = location.hash.split('/')[1]; if (id) this.openTopicDetailById(id); }
        window.addEventListener('hashchange', ()=>{ if (location.hash.startsWith('#topic/')) { const id = location.hash.split('/')[1]; if (id) this.openTopicDetailById(id); }});
      }

      setupFeedTesting() {
        const testFeedBtn = document.getElementById('btnTestFeed');
        const feedSection = document.getElementById('feedTestSection');
        const testBtn = document.getElementById('testFeedBtn');
        const testUrl = document.getElementById('testFeedUrl');
        const results = document.getElementById('testResults');

        testFeedBtn.addEventListener('click', () => {
          feedSection.style.display = feedSection.style.display === 'none' ? 'block' : 'none';
        });

        testBtn.addEventListener('click', async () => {
          const url = testUrl.value.trim();
          if (!url) return;

          results.style.display = 'block';
          results.innerHTML = '<div class="loading-pulse">üîÑ Testing feed...</div>';

          try {
            const articles = await FeedParser.parse(url);
            
            if (articles.length === 0) {
              results.innerHTML = '<div style="color: #ff4444;">‚ùå No articles found or feed error</div>';
              return;
            }

            let html = `<div style="color: #00ff88; margin-bottom: 10px;">‚úÖ Found ${articles.length} articles</div>`;
            
            articles.forEach((article, i) => {
              const category = this.categorizer.categorizeArticle(article);
              const categoryName = category ? this.topics.find(t => t.id === category)?.title || category : 'Uncategorized';
              
              html += `
                <div style="border: 1px solid #333; border-radius: 5px; padding: 10px; margin: 5px 0;">
                  <div style="color: #00ff88; font-weight: bold;">${this.escapeHTML(article.title)}</div>
                  <div style="color: #888; font-size: 0.9em; margin: 5px 0;">
                    Category: <span style="color: #ffd700;">${categoryName}</span> | 
                    Score: <span style="color: #ff4444;">${article.score}</span>
                  </div>
                  <div style="color: #ccc; font-size: 0.8em;">${article.description || 'No description'}</div>
                </div>
              `;
            });

            results.innerHTML = html;
          } catch (error) {
            results.innerHTML = `<div style="color: #ff4444;">‚ùå Error: ${error.message}</div>`;
          }
        });
      }

      setupModals() {
        this.setupNewCardModal();
        this.setupImportExport();
      }

      setupNewCardModal() {
        const modal = document.getElementById('newCardModal');
        const openBtn = document.getElementById('btnNewCard');
        const cancel = document.getElementById('nc_cancel');
        const form = document.getElementById('newCardForm');
        const titleEl = document.getElementById('nc_title');
        const idEl = document.getElementById('nc_id');

        const open = () => { 
          modal.classList.remove('hidden'); 
          modal.setAttribute('aria-hidden','false'); 
          form.reset();
          titleEl.focus(); 
        };
        
        const close = () => { 
          modal.classList.add('hidden'); 
          modal.setAttribute('aria-hidden','true'); 
        };

        openBtn.addEventListener('click', open);
        cancel.addEventListener('click', close);
        modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
        
        document.addEventListener('keydown', (e)=>{
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
          if (e.ctrlKey && e.key.toLowerCase() === 'n') { e.preventDefault(); open(); }
        });

        titleEl.addEventListener('input', ()=>{ 
          if(!idEl.value) idEl.value = this.slugify(titleEl.value); 
        });

        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const topic = this.readNewCardForm();
          const err = this.validateTopic(topic);
          if (err) { alert(err); return; }
          this.addTopic(topic);
          close();
        });
      }

      readNewCardForm() {
        const getValue = (id) => document.getElementById(id).value.trim();
        
        return {
          id: getValue('nc_id'),
          title: getValue('nc_title'),
          keywords: getValue('nc_keywords').split(',').map(k => k.trim()).filter(k => k),
          currentScore: parseFloat(getValue('nc_currentScore')) || 0,
          yesterdayScore: parseFloat(getValue('nc_yesterdayScore')) || 0,
          monthlyAvg: parseFloat(getValue('nc_monthlyAvg')) || 0,
          todayArticles: parseInt(getValue('nc_todayArticles'), 10) || 0,
          url: getValue('nc_url'),
          feedUrl: getValue('nc_feedUrl') || null
        };
      }

      validateTopic(t) {
        if (!t.title) return 'Please enter a title.';
        if (!t.id) return 'Please enter a slug/ID.';
        if (!/^[a-z0-9_]+$/i.test(t.id)) return 'ID must be letters/numbers/underscores only.';
        if (this.topicExists(t.id)) return `A topic with id "${t.id}" already exists.`;
        if (t.currentScore < 0 || t.currentScore > 10) return 'Current Score must be 0‚Äì10.';
        if (t.yesterdayScore < 0 || t.yesterdayScore > 10) return 'Yesterday Score must be 0‚Äì10.';
        if (t.monthlyAvg < 0 || t.monthlyAvg > 10) return 'Monthly Avg must be 0‚Äì10.';
        if (!t.url) return 'Please provide a target URL.';
        return null;
      }

      addTopic(topic) {
        this.topics.push(topic);
        this.categorizer.addCategory(topic.id, topic.keywords);
        this.saveTopics();
        this.renderTopicCards();
        this.loadTopicArticles(topic.id);
      }

      setupImportExport() {
        const exportBtn = document.getElementById('btnExport');
        const importBtn = document.getElementById('btnImport');
        const importModal = document.getElementById('importModal');
        const importCancel = document.getElementById('import_cancel');
        const importConfirm = document.getElementById('import_confirm');
        const importData = document.getElementById('importData');

        exportBtn.addEventListener('click', () => {
          const data = JSON.stringify(this.topics, null, 2);
          const blob = new Blob([data], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `bpi-topics-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
        });

        importBtn.addEventListener('click', () => {
          importModal.classList.remove('hidden');
          importData.focus();
        });

        importCancel.addEventListener('click', () => {
          importModal.classList.add('hidden');
        });

        importConfirm.addEventListener('click', () => {
          try {
            const data = JSON.parse(importData.value);
            if (!Array.isArray(data)) throw new Error('Data must be an array');
            
            data.forEach((item, index) => {
              if (!item.id || !item.title) {
                throw new Error(`Invalid item at index ${index}: missing id or title`);
              }
            });

            this.topics = data;
            this.setupCategorizer();
            this.saveTopics();
            this.renderTopicCards();
            importModal.classList.add('hidden');
            importData.value = '';
            alert('Data imported successfully!');
          } catch (e) {
            alert('Import failed: ' + e.message);
          }
        });
      }

      renderTopicCards() {
        const container = document.getElementById('topicContainer');
        if (!container) return;

        const domains = {
          god_theology_centered: '‚úùÔ∏è God / Theology-Centered',
          prophetic_end_times: 'üîç Prophetic End Times',
          moral_cultural_battlegrounds: 'üî• Moral & Cultural Battlegrounds',
          geopolitical_societal_shifts: 'üåç Geopolitical and Societal Shifts',
          spiritual_formation_discipleship: 'üß† Spiritual Formation & Discipleship',
          technological_scientific_developments: 'üß™ Technological & Scientific Developments',
          watchlist_emerging_threats: '‚ö†Ô∏è Watchlist / Emerging Threats'
        };

        const groupedTopics = this.topics.reduce((groups, topic) => {
          const domain = topic.domain || 'uncategorized';
          if (!groups[domain]) {
            groups[domain] = [];
          }
          groups[domain].push(topic);
          return groups;
        }, {});

        let html = '';
        for (const domainId in domains) {
          if (groupedTopics[domainId]) {
            html += `<h2 class="domain-header">${domains[domainId]}</h2>`;
            const topicsInDomain = groupedTopics[domainId].sort((a, b) => b.currentScore - a.currentScore);
            
            html += '<div class="topic-grid">';
            topicsInDomain.forEach(topic => {
              const scoreClass = topic.currentScore >= 8 ? 'score-high' :
                               topic.currentScore >= 6 ? 'score-medium' : 'score-low';
              const trend = topic.currentScore > topic.yesterdayScore ? '‚ÜóÔ∏è' :
                           topic.currentScore < topic.yesterdayScore ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
              const trendColor = topic.currentScore > topic.yesterdayScore ? '#00ff88' :
                                topic.currentScore < topic.yesterdayScore ? '#ff4444' : '#ffff00';
              const weeklyTrend = topic.weeklyTrend > 0 ? '‚ÜóÔ∏è' : topic.weeklyTrend < 0 ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
              const weeklyTrendColor = topic.weeklyTrend > 0 ? '#00ff88' : topic.weeklyTrend < 0 ? '#ff4444' : '#ffff00';
              const keywordsHTML = topic.keywords.map(k => `<a href="#" class="keyword">${this.escapeHTML(k)}</a>`).join(' ');
              const subCategoriesHTML = topic.subCategories.map(k => `<a href="#" class="subcategory">${this.escapeHTML(k)}</a>`).join(' ');

              html += `
                <div class="topic-card" data-id="${topic.id}">
                  <button class="card-delete" title="Remove" aria-label="Remove card" data-id="${topic.id}">√ó</button>
                  <div class="topic-header">
                    <div class="topic-title" data-id="${topic.id}">${this.escapeHTML(topic.title)}</div>
                    <div class="topic-score ${scoreClass}">${topic.currentScore}</div>
                  </div>
                  <div class="topic-keywords">${keywordsHTML}</div>
                  <div class="topic-subcategories">${subCategoriesHTML}</div>
                  <div class="topic-stats" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="mini-stat">
                      <div class="mini-stat-number" style="color:${trendColor}">${trend}</div>
                      <div class="mini-stat-label">vs Yesterday</div>
                    </div>
                    <div class="mini-stat">
                      <div class="mini-stat-number" style="color:${weeklyTrendColor}">${weeklyTrend} ${topic.weeklyTrend}</div>
                      <div class="mini-stat-label">Weekly Trend</div>
                    </div>
                    <div class="mini-stat">
                      <div class="mini-stat-number">${topic.monthlyAvg}</div>
                      <div class="mini-stat-label">Monthly Avg</div>
                    </div>
                    <div class="mini-stat">
                      <div class="mini-stat-number">${topic.todayArticles}</div>
                      <div class="mini-stat-label">Today's Articles</div>
                    </div>
                  </div>
                  <div class="recent-articles" id="articles-${topic.id}"></div>
                </div>
              `;
            });
            html += '</div>';
          }
        }

        container.innerHTML = html;

        this.setupCardEventListeners(container);
        this.topics.forEach(topic => this.loadTopicArticles(topic.id));
      }

      
      
setupCardEventListeners(container) {
        container.querySelectorAll('.topic-title').forEach(title => {
          title.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = title.getAttribute('data-id');
            window.location.href = `topic.html?id=${id}`;
          });
        });

        container.querySelectorAll('.card-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this card?')) {
              this.topics = this.topics.filter(t => t.id !== id);
              this.saveTopics();
              this.renderTopicCards();
            }
          });
        });
      }

      renderTopicArticles(topicId, articles) {
        const container = document.getElementById(`articles-${topicId}`);
        if (!container) return;
        
        container.textContent = "";
        
        articles.forEach(article => {
          const item = document.createElement('div');
          item.className = 'article-item';
          item.addEventListener('click', () => {
            window.open(article.url, '_blank', 'noopener,noreferrer');
          });

          const title = document.createElement('div');
          title.className = 'article-title';
          title.textContent = article.title || 'Untitled';

          const meta = document.createElement('div');
          meta.className = 'article-meta';

          const time = document.createElement('span');
          time.textContent = this.getTimeAgo(article.publishedAt);

          const score = document.createElement('span');
          score.className = 'article-score';
          score.textContent = String(article.score || '-');

          meta.append(time, score);
          item.append(title, meta);
          container.append(item);
        });
      }

      renderGlobalStats() {
        const container = document.getElementById('globalStatsGrid');
        const totalArticles = this.topics.reduce((sum, t) => sum + t.todayArticles, 0);
        const avgScore = this.topics.reduce((sum, t) => sum + t.currentScore, 0) / this.topics.length;
        
        const stats = [
          { number: totalArticles.toLocaleString(), label: 'Articles Today' },
          { number: this.topics.length.toString(), label: 'Active Topics' },
          { number: avgScore.toFixed(1), label: 'Average Score' },
          { number: '98.7%', label: 'System Uptime' },
          { number: '0.8s', label: 'Avg Response Time' },
          { number: Math.floor(totalArticles * 0.15).toString(), label: 'Critical Alerts' }
        ];
        
        container.innerHTML = stats.map(s => `
          <div class="stat-card">
            <div class="stat-number">${s.number}</div>
            <div class="stat-label">${s.label}</div>
          </div>
        `).join('');
      }

      startRealTimeUpdates() {
        setInterval(() => {
          this.updateTopicScores();
          this.updateGlobalMeter();
          this.updateTicker();
          this.processFeeds();
        }, this.updateInterval);
      }

      async processFeeds() {
        for (const topic of this.topics) {
          if (topic.feedUrl) {
            try {
              const articles = await FeedParser.parse(topic.feedUrl);
              if (articles.length > 0) {
                topic.todayArticles = articles.length;
                this.renderTopicArticles(topic.id, articles.slice(0, 7));
              }
            } catch (error) {
              console.warn(`Feed processing error for ${topic.id}:`, error);
            }
          }
        }
        this.saveTopics();
      }

      updateTopicScores() {
        this.topics.forEach(t => {
          const change = (Math.random() - 0.5) * 0.4;
          t.yesterdayScore = t.currentScore;
          t.currentScore = Math.max(0, Math.min(10, t.currentScore + change));
          t.currentScore = Math.round(t.currentScore * 10) / 10;
        });
        this.renderTopicCards();
        this.renderGlobalStats();
      }

      updateGlobalMeter() {
        const globalScore = this.calculateGlobalScore();
        const fill = document.getElementById('globalProgress');
        const pct = document.getElementById('globalPercentage');
        const status = document.getElementById('globalStatus');

        fill.style.width = globalScore + '%';
        pct.textContent = Math.round(globalScore) + '%';

        if (globalScore >= 90) { 
          status.textContent = 'IMMINENT CONVERGENCE'; 
          status.style.color = '#ff0000'; 
        }
        else if (globalScore >= 80) { 
          status.textContent = 'CRITICAL CONVERGENCE'; 
          status.style.color = '#ff4444'; 
        }
        else if (globalScore >= 70) { 
          status.textContent = 'HIGH PROBABILITY'; 
          status.style.color = '#ffaa00'; 
        }
        else { 
          status.textContent = 'MODERATE ACTIVITY'; 
          status.style.color = '#00ff88'; 
        }
      }

      calculateGlobalScore() {
        const avg = this.topics.reduce((s,t)=> s + t.currentScore, 0) / Math.max(1, this.topics.length);
        return Math.min(100, avg * 11);
      }

      updateTicker() {
        const items = [
          { score: 8.7, text: 'Major development in Jerusalem temple mount negotiations', level:'critical' },
          { score: 7.2, text: 'EU announces digital ID implementation timeline acceleration', level:'high' },
          { score: 6.8, text: 'Vatican makes significant interfaith unity announcement', level:'medium' },
          { score: 8.3, text: 'Central banks coordinate global digital currency launch', level:'critical' },
          { score: 7.6, text: 'Middle East peace treaty discussions resume in Geneva', level:'high' }
        ];
        
        const html = items.map(it => {
          const icon = it.level === 'critical' ? 'üî¥' : it.level === 'high' ? 'üü°' : 'üü¢';
          return `<div class="ticker-item ticker-${it.level}">${icon} [Score: ${it.score}] ${this.escapeHTML(it.text)}</div>`;
        }).join('');
        
        document.getElementById('liveTicker').innerHTML = html;
      }

      async loadTopicArticles(topicId) {
        const topic = this.topics.find(t => t.id === topicId);
        
        try {
          let articles = [];
          
          if (topic?.feedUrl) {
            articles = await FeedParser.parse(topic.feedUrl);
          }
          
          if (articles.length === 0) {
            articles = this.getDemoArticles(topicId);
          }
          
          this.renderTopicArticles(topicId, articles.slice(0, 7));
        } catch (error) {
          console.warn(`Error loading articles for ${topicId}:`, error);
          const demo = this.getDemoArticles(topicId);
          this.renderTopicArticles(topicId, demo);
        }
      }

      getDemoArticles(topicId) {
        const demo = {
          antichrist: [
            { title:'EU Leader Proposes New Global Governance Framework', score:8.7, url:'#', publishedAt: Date.now()-3600000 },
            { title:'International Peace Summit Scheduled for Jerusalem', score:8.2, url:'#', publishedAt: Date.now()-7200000 },
            { title:'Tech Mogul Announces Universal ID Platform', score:7.9, url:'#', publishedAt: Date.now()-10800000 }
          ],
          temple_mount: [
            { title:'Third Temple Foundation Stones Delivered to Jerusalem', score:9.1, url:'#', publishedAt: Date.now()-900000 },
            { title:'Red Heifer Born in Israel Deemed Suitable for Sacrifice', score:8.8, url:'#', publishedAt: Date.now()-4500000 },
            { title:'Temple Institute Completes High Priest Garments', score:8.5, url:'#', publishedAt: Date.now()-8100000 }
          ],
          israel_security: [
            { title:'Israel Deploys New AI Defense System Along Borders', score:8.9, url:'#', publishedAt: Date.now()-450000 },
            { title:'Regional Powers Form New Military Alliance Against Israel', score:8.6, url:'#', publishedAt: Date.now()-3150000 },
            { title:'UN Security Council Calls Emergency Session on Middle East', score:8.3, url:'#', publishedAt: Date.now()-7650000 }
          ],
          digital_currency: [
            { title:'WHO Partners with Tech Giants on Global Health ID', score:8.3, url:'#', publishedAt: Date.now()-1350000 },
            { title:'Biometric Payment Systems Launch in European Cities', score:8.0, url:'#', publishedAt: Date.now()-4950000 },
            { title:'Central Bank Digital Currencies Testing Phase Complete', score:7.7, url:'#', publishedAt: Date.now()-11700000 }
          ],
          middle_east_war: [
            { title:'NATO Deploys Forces to Eastern Mediterranean', score:7.8, url:'#', publishedAt: Date.now()-1200000 },
            { title:'Iran Accelerates Nuclear Program Amid Tensions', score:7.5, url:'#', publishedAt: Date.now()-3600000 },
            { title:'Russia and Turkey Form New Defense Partnership', score:7.2, url:'#', publishedAt: Date.now()-6600000 }
          ],
          church_decline: [
            { title:'Major Denomination Abandons Biblical Marriage Definition', score:7.4, url:'#', publishedAt: Date.now()-2700000 },
            { title:'Seminary Removes Biblical Inerrancy from Curriculum', score:7.1, url:'#', publishedAt: Date.now()-6300000 },
            { title:'Church Attendance Hits All-Time Low in Western Nations', score:6.8, url:'#', publishedAt: Date.now()-12600000 }
          ]
        };
        return demo[topicId] || [];
      }

      getTimeAgo(ts) {
        const now = Date.now();
        const t = (ts instanceof Date) ? ts.getTime() : (typeof ts === 'number' ? ts : Date.parse(ts));
        const diff = Math.max(0, Math.floor((now - t) / 1000));
        if (diff < 60) return `${diff}s ago`;
        if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
        return `${Math.floor(diff/86400)}d ago`;
      }

      setupEventListeners() {
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key.toLowerCase() === 'r') {
            e.preventDefault();
            this.renderTopicCards();
            this.renderGlobalStats();
          }
        });
        
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.renderTopicCards();
            this.renderGlobalStats();
          }
        });
      }
    }

    // Initialize Dashboard
    const boot = () => {
      try { 
        console.log('üöÄ Initializing Biblical Prophecy Intelligence Dashboard...');
        new ProphecyIntelligenceDashboard(); 
      }
      catch (e) { 
        console.error('‚ùå Dashboard initialization failed:', e); 
      }
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot, { once: true });
    } else { 
      boot(); 
    }

    console.log(`
üåç BIBLICAL PROPHECY INTELLIGENCE DASHBOARD
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Features:
‚úî Smart feed categorization with keywords
‚úî Real-time score updates and statistics  
‚úî Feed testing and validation tools
‚úî Import/export data functionality
‚úî Persistent storage with localStorage
‚úî 3 news slots per category with click-through
‚úî Mobile responsive design
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Ready to deploy to GitHub and host!
`);
  </script>

  
</body>
</html>